version: '3.8'

services:
  db-test:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: poll_system_test
      MYSQL_USER: test_user
      MYSQL_PASSWORD: test_password
      MYSQL_ROOT_PASSWORD: root_test_password
    tmpfs:
      - /var/lib/mysql
    command: --innodb-flush-method=O_DIRECT --innodb-flush-log-at-trx-commit=0 --sync-binlog=0

  web:
    build: .
    environment:
      - DEBUG=True
      - SECRET_KEY=test-secret-key
      - DB_NAME=poll_system_test
      - DB_USER=test_user
      - DB_PASSWORD=test_password
      - DB_HOST=db-test
      - DB_PORT=3306
      - ALLOWED_HOSTS=localhost,127.0.0.1
    depends_on:
      - db-test
    command: >
      sh -c "python manage.py migrate &&
             python manage.py test polls.tests"